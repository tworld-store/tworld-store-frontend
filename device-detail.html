<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>기기 상세 - SKT 공식 온라인샵</title>
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <!-- 헤더 -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo">
                    <span class="logo-text">T&SHOP</span>
                </a>
                <nav class="main-nav">
                    <a href="devices.html?brand=samsung">삼성</a>
                    <a href="devices.html?brand=apple">애플</a>
                    <a href="devices.html">전체기기</a>
                    <a href="plans.html">요금제</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- 메인 컨텐츠 -->
    <main class="detail-page">
        <div class="container">
            <!-- 상단 섹션: 갤러리 + 옵션 -->
            <div class="detail-container" id="detail-container">
                <!-- 좌측: 이미지 갤러리 (60%) -->
                <div class="gallery-section">
                    <!-- 큰 이미지 -->
                    <div class="main-image-wrapper">
                        <img id="main-image" src="" alt="기기 이미지" class="main-image">
                    </div>
                    
                    <!-- 썸네일 그리드 (2x2) -->
                    <div class="thumbnail-grid" id="thumbnail-grid">
                        <!-- JS로 동적 생성 -->
                    </div>
                </div>

                <!-- 우측: 옵션 및 가격 (40%) -->
                <div class="options-section">
                    <!-- 모델명 -->
                    <h1 class="device-name" id="device-name">로딩 중...</h1>
                    
                    <!-- 색상 선택 -->
                    <div class="option-group">
                        <label class="option-label">색상</label>
                        <div class="color-options" id="color-options">
                            <!-- JS로 동적 생성 -->
                        </div>
                    </div>

                    <!-- 용량 선택 -->
                    <div class="option-group">
                        <label class="option-label">용량</label>
                        <div class="capacity-options" id="capacity-options">
                            <!-- JS로 동적 생성 -->
                        </div>
                    </div>

                    <!-- 가입유형 선택 -->
                    <div class="option-group">
                        <label class="option-label">가입유형</label>
                        <select id="join-type-select" class="option-select">
                            <option value="기기변경">기기변경</option>
                            <option value="번호이동">번호이동</option>
                            <option value="신규가입">신규가입</option>
                        </select>
                    </div>

                    <!-- 요금제 선택 -->
                    <div class="option-group">
                        <label class="option-label">요금제</label>
                        <select id="plan-select" class="option-select">
                            <option value="">요금제를 선택하세요</option>
                            <!-- JS로 동적 생성 -->
                        </select>
                    </div>

                    <!-- 할인 방법 -->
                    <div class="option-group">
                        <label class="option-label">할인 방법</label>
                        <div class="discount-options">
                            <label class="radio-option">
                                <input type="radio" name="discount-type" value="subsidy" checked>
                                <span>휴대폰 가격 할인 (지원금약정)</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="discount-type" value="select">
                                <span>통신요금 25%할인 (선택약정)</span>
                            </label>
                        </div>
                    </div>

                    <!-- 인터넷+TV 결합 -->
                    <div class="option-group">
                        <label class="option-label">인터넷+TV</label>
                        <div class="bundle-options">
                            <label class="radio-option">
                                <input type="radio" name="internet-tv" value="none" checked>
                                <span>선택안함</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="internet-tv" value="internet">
                                <span>상담신청 (인터넷 -5,000원)</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="internet-tv" value="both">
                                <span>상담신청 (인터넷+TV -10,000원)</span>
                            </label>
                        </div>
                    </div>

                    <!-- 할부 개월 -->
                    <div class="option-group">
                        <label class="option-label">할부 개월</label>
                        <div class="installment-options">
                            <label class="radio-option">
                                <input type="radio" name="installment" value="0">
                                <span>일시불</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="installment" value="12">
                                <span>12개월</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="installment" value="24" checked>
                                <span>24개월</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="installment" value="36">
                                <span>36개월</span>
                            </label>
                        </div>
                    </div>

                    <!-- 가격 정보 -->
                    <div class="price-summary">
                        <h3 class="price-section-title">월 휴대폰 요금</h3>
                        <div class="price-detail-row">
                            <span>출고가</span>
                            <span id="release-price">-</span>
                        </div>
                        <div class="price-detail-row discount">
                            <span>휴대폰 할인금</span>
                            <span id="phone-discount">-</span>
                        </div>
                        <div class="price-detail-row">
                            <span>할부원금</span>
                            <span id="installment-principal">-</span>
                        </div>
                        <div class="price-result-row">
                            <span>월 휴대폰 요금</span>
                            <span class="price-highlight" id="monthly-phone">-</span>
                        </div>

                        <hr class="divider">

                        <h3 class="price-section-title">월 통신요금</h3>
                        <div class="price-detail-row">
                            <span>요금제</span>
                            <span id="base-plan-fee">-</span>
                        </div>
                        <div class="price-detail-row discount">
                            <span>요금할인</span>
                            <span id="plan-discount">-</span>
                        </div>
                        <div class="price-detail-row discount">
                            <span>결합할인</span>
                            <span id="bundle-discount">-</span>
                        </div>
                        <div class="price-result-row">
                            <span>월 통신요금</span>
                            <span class="price-highlight" id="monthly-plan">-</span>
                        </div>

                        <hr class="divider">

                        <div class="price-total-row">
                            <span>월 예상 납부 금액</span>
                            <span class="price-total" id="monthly-total">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 하단 상세 섹션 -->
            <div class="detail-sections" id="detail-sections">
                <!-- JS로 동적 생성 -->
            </div>
        </div>
    </main>

    <!-- 하단 고정 푸터 -->
    <div class="fixed-footer" id="fixed-footer">
        <div class="container">
            <div class="footer-price-summary">
                <div class="footer-price-item">
                    <span class="footer-label">월 휴대폰 요금</span>
                    <span class="footer-value" id="footer-monthly-phone">-</span>
                </div>
                <span class="footer-plus">+</span>
                <div class="footer-price-item">
                    <span class="footer-label">월 통신요금</span>
                    <span class="footer-value" id="footer-monthly-plan">-</span>
                </div>
                <span class="footer-equals">=</span>
                <div class="footer-price-item total">
                    <span class="footer-label">월 예상 납부 금액</span>
                    <span class="footer-value-total" id="footer-monthly-total">-</span>
                </div>
            </div>
            <div class="footer-actions">
                <button class="btn-consult">상담신청</button>
                <button class="btn-order">주문하기</button>
            </div>
        </div>
    </div>

    <!-- 페이지 푸터 -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-info">
                    <p>고객센터: 1600-8939</p>
                    <p>상담시간: 평일 09:00 - 18:00</p>
                </div>
                <div class="footer-legal">
                    <p>© 2025 SKT. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- JS 파일 로드 -->
    <script src="/js/cloudinary.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/calculator.js"></script>
    <script src="/js/common.js"></script>
    
    <!-- 인라인 스크립트 -->
    <script>
        /**
         * ═══════════════════════════════════════════════════
         * device-detail.html 메인 스크립트
         * ═══════════════════════════════════════════════════
         */

        // Cloudinary 설정
        setCloudinaryConfig('your-cloud-name');

        // 전역 변수
        let currentModel = '';
        let currentColor = '';
        let currentCapacity = 0;
        let allPlans = [];
        let devicesByCapacity = {};
        let galleryImages = {};

        /**
         * ───────────────────────────────────────────────
         * 페이지 초기화
         * ───────────────────────────────────────────────
         */
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('🚀 device-detail.html 로드 시작');
                
                // URL에서 모델명 가져오기
                const params = new URLSearchParams(window.location.search);
                currentModel = params.get('model');
                
                if (!currentModel) {
                    throw new Error('모델명이 없습니다');
                }
                
                console.log(`📱 모델: ${currentModel}`);
                
                // 데이터 로드
                await loadDetailPage();
                
                // 이벤트 리스너 등록
                setupEventListeners();
                
                console.log('✅ device-detail.html 로드 완료');
                
            } catch (error) {
                console.error('❌ 페이지 로드 실패:', error);
                showError('페이지를 불러오는 중 오류가 발생했습니다.');
            }
        });

        /**
         * ───────────────────────────────────────────────
         * 상세 페이지 데이터 로드
         * ───────────────────────────────────────────────
         */
        async function loadDetailPage() {
            try {
                // 1. 이미지 데이터 로드 (통합)
                const images = await api.getModelImages(currentModel);
                console.log('✅ 이미지 데이터 로드 완료');
                
                // 2. 해당 모델의 모든 기기옵션 로드
                const devices = await api.getDevicesByModel(currentModel);
                console.log(`✅ 기기옵션 ${devices.length}개 로드 완료`);
                
                if (devices.length === 0) {
                    throw new Error('기기 정보를 찾을 수 없습니다');
                }
                
                // 3. 용량별로 그룹화
                devicesByCapacity = {};
                devices.forEach(device => {
                    if (!devicesByCapacity[device.용량]) {
                        devicesByCapacity[device.용량] = [];
                    }
                    devicesByCapacity[device.용량].push(device);
                });
                
                // 4. 요금제 목록 로드
                allPlans = await api.getPlans();
                console.log(`✅ 요금제 ${allPlans.length}개 로드 완료`);
                
                // 5. 갤러리 이미지 저장
                galleryImages = images.gallery;
                
                // 6. 초기 값 설정
                const firstCapacity = Object.keys(devicesByCapacity)[0];
                const firstDevice = devicesByCapacity[firstCapacity][0];
                currentCapacity = firstDevice.용량;
                currentColor = firstDevice.색상명;
                
                // 7. UI 렌더링
                renderDeviceName(images.card.title);
                renderColorOptions(devices);
                renderCapacityOptions();
                renderPlanOptions();
                renderGallery(currentColor);
                renderDetailSections(images.detail_sections);
                
                // 8. 초기 가격 계산
                await updatePrice();
                
            } catch (error) {
                console.error('❌ 데이터 로드 실패:', error);
                throw error;
            }
        }

        /**
         * ───────────────────────────────────────────────
         * 모델명 렌더링
         * ───────────────────────────────────────────────
         */
        function renderDeviceName(title) {
            document.getElementById('device-name').textContent = title;
            document.title = `${title} - SKT 공식 온라인샵`;
        }

        /**
         * ───────────────────────────────────────────────
         * 색상 옵션 렌더링
         * ───────────────────────────────────────────────
         */
        function renderColorOptions(devices) {
            const container = document.getElementById('color-options');
            container.innerHTML = '';
            
            // 색상 목록 추출 (중복 제거)
            const colors = [...new Set(devices.map(d => d.색상명))];
            
            colors.forEach((color, index) => {
                const btn = document.createElement('button');
                btn.className = 'color-btn' + (index === 0 ? ' active' : '');
                btn.textContent = color;
                btn.onclick = () => selectColor(color);
                container.appendChild(btn);
            });
        }

        /**
         * ───────────────────────────────────────────────
         * 용량 옵션 렌더링
         * ───────────────────────────────────────────────
         */
        function renderCapacityOptions() {
            const container = document.getElementById('capacity-options');
            container.innerHTML = '';
            
            const capacities = Object.keys(devicesByCapacity).sort((a, b) => a - b);
            
            capacities.forEach((capacity, index) => {
                const btn = document.createElement('button');
                btn.className = 'capacity-btn' + (index === 0 ? ' active' : '');
                btn.textContent = `${capacity}GB`;
                btn.onclick = () => selectCapacity(parseInt(capacity));
                container.appendChild(btn);
            });
        }

        /**
         * ───────────────────────────────────────────────
         * 요금제 옵션 렌더링
         * ───────────────────────────────────────────────
         */
        function renderPlanOptions() {
            const select = document.getElementById('plan-select');
            
            allPlans.forEach(plan => {
                const option = document.createElement('option');
                option.value = plan.요금제ID;
                option.textContent = `${plan.요금제명} (${formatPrice(plan.기본요금)})`;
                select.appendChild(option);
            });
            
            // 첫 번째 요금제 선택
            if (allPlans.length > 0) {
                select.value = allPlans[0].요금제ID;
            }
        }

        /**
         * ───────────────────────────────────────────────
         * 갤러리 렌더링
         * ───────────────────────────────────────────────
         */
        function renderGallery(colorName) {
            const images = galleryImages[colorName];
            
            if (!images || images.length === 0) {
                console.warn(`갤러리 이미지 없음: ${colorName}`);
                return;
            }
            
            // 큰 이미지 (첫 번째)
            const mainImg = document.getElementById('main-image');
            mainImg.src = getImageUrl(images[0].path, { width: 720, height: 720 });
            mainImg.alt = images[0].alt;
            
            // 썸네일 그리드 (2x2)
            const thumbnailContainer = document.getElementById('thumbnail-grid');
            thumbnailContainer.innerHTML = '';
            
            // 썸네일용 이미지 (is_thumbnail === true인 것들, 최대 4개)
            const thumbnails = images.filter(img => img.is_thumbnail).slice(0, 4);
            
            thumbnails.forEach((img, index) => {
                const thumbBtn = document.createElement('button');
                thumbBtn.className = 'thumbnail-item' + (index === 0 ? ' active' : '');
                thumbBtn.onclick = () => selectThumbnail(img.path, img.alt, index);
                
                const thumbImg = document.createElement('img');
                thumbImg.src = getImageUrl(img.path, { width: 200, height: 200 });
                thumbImg.alt = img.alt;
                
                thumbBtn.appendChild(thumbImg);
                thumbnailContainer.appendChild(thumbBtn);
            });
        }

        /**
         * ───────────────────────────────────────────────
         * 썸네일 선택
         * ───────────────────────────────────────────────
         */
        function selectThumbnail(path, alt, index) {
            // 큰 이미지 변경
            const mainImg = document.getElementById('main-image');
            mainImg.src = getImageUrl(path, { width: 720, height: 720 });
            mainImg.alt = alt;
            
            // 썸네일 활성화 상태 변경
            document.querySelectorAll('.thumbnail-item').forEach((thumb, i) => {
                if (i === index) {
                    thumb.classList.add('active');
                } else {
                    thumb.classList.remove('active');
                }
            });
        }

        /**
         * ───────────────────────────────────────────────
         * 하단 상세 섹션 렌더링
         * ───────────────────────────────────────────────
         */
        function renderDetailSections(sections) {
            const container = document.getElementById('detail-sections');
            container.innerHTML = '';
            
            sections.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'detail-section-item';
                
                const img = document.createElement('img');
                img.src = getDetailSectionUrl(section.path);
                img.alt = section.alt;
                img.loading = 'lazy';
                
                sectionDiv.appendChild(img);
                container.appendChild(sectionDiv);
            });
        }

        /**
         * ───────────────────────────────────────────────
         * 색상 선택
         * ───────────────────────────────────────────────
         */
        function selectColor(color) {
            currentColor = color;
            
            // 버튼 활성화 상태 변경
            document.querySelectorAll('.color-btn').forEach(btn => {
                if (btn.textContent === color) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // 갤러리 업데이트
            renderGallery(color);
            
            // 가격 재계산
            updatePrice();
        }

        /**
         * ───────────────────────────────────────────────
         * 용량 선택
         * ───────────────────────────────────────────────
         */
        function selectCapacity(capacity) {
            currentCapacity = capacity;
            
            // 버튼 활성화 상태 변경
            document.querySelectorAll('.capacity-btn').forEach(btn => {
                if (btn.textContent === `${capacity}GB`) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // 가격 재계산
            updatePrice();
        }

        /**
         * ───────────────────────────────────────────────
         * 가격 업데이트 (메인 함수)
         * ───────────────────────────────────────────────
         */
        async function updatePrice() {
            try {
                // 1. 현재 선택된 옵션들
                const joinType = document.getElementById('join-type-select').value;
                const planId = document.getElementById('plan-select').value;
                const discountType = document.querySelector('input[name="discount-type"]:checked').value;
                const internetTv = document.querySelector('input[name="internet-tv"]:checked').value;
                const installmentMonths = parseInt(document.querySelector('input[name="installment"]:checked').value);
                
                if (!planId) {
                    console.warn('요금제가 선택되지 않았습니다');
                    return;
                }
                
                // 2. 기기옵션ID 생성
                const deviceOptionId = `${currentModel}_${currentCapacity}GB`;
                
                // 3. 데이터 로드
                const device = await api.getDeviceOption(deviceOptionId);
                const plan = await api.getPlan(planId);
                const subsidy = await api.getSubsidy(deviceOptionId, planId, joinType);
                
                if (!device || !plan || !subsidy) {
                    console.error('필요한 데이터를 찾을 수 없습니다');
                    return;
                }
                
                // 4. 가격 계산
                const result = calculatePrice(device, plan, subsidy, {
                    discountType: discountType,
                    installmentMonths: installmentMonths,
                    internetTv: internetTv
                });
                
                // 5. UI 업데이트
                displayPrice(result);
                
            } catch (error) {
                console.error('❌ 가격 계산 실패:', error);
            }
        }

        /**
         * ───────────────────────────────────────────────
         * 가격 표시
         * ───────────────────────────────────────────────
         */
        function displayPrice(result) {
            // 출고가
            document.getElementById('release-price').textContent = formatPrice(result.releasePrice);
            
            // 휴대폰 할인금
            const phoneDiscount = result.subsidy.total;
            document.getElementById('phone-discount').textContent = formatDiscount(phoneDiscount);
            
            // 할부원금
            document.getElementById('installment-principal').textContent = formatPrice(result.installmentPrincipal);
            
            // 월 휴대폰 요금
            document.getElementById('monthly-phone').textContent = formatPrice(result.monthlyInstallment);
            
            // 요금제 기본료
            document.getElementById('base-plan-fee').textContent = formatPrice(result.basePlanFee);
            
            // 요금할인
            document.getElementById('plan-discount').textContent = formatDiscount(result.planDiscount);
            
            // 결합할인
            document.getElementById('bundle-discount').textContent = formatDiscount(result.bundleDiscount);
            
            // 월 통신요금
            document.getElementById('monthly-plan').textContent = formatPrice(result.monthlyPlanFee);
            
            // 월 예상 납부 금액
            document.getElementById('monthly-total').textContent = formatPrice(result.monthlyTotal);
            
            // 하단 고정 푸터도 업데이트
            document.getElementById('footer-monthly-phone').textContent = formatPrice(result.monthlyInstallment);
            document.getElementById('footer-monthly-plan').textContent = formatPrice(result.monthlyPlanFee);
            document.getElementById('footer-monthly-total').textContent = formatPrice(result.monthlyTotal);
        }

        /**
         * ───────────────────────────────────────────────
         * 이벤트 리스너 설정
         * ───────────────────────────────────────────────
         */
        function setupEventListeners() {
            // 가입유형 변경
            document.getElementById('join-type-select').addEventListener('change', updatePrice);
            
            // 요금제 변경
            document.getElementById('plan-select').addEventListener('change', updatePrice);
            
            // 할인 방법 변경
            document.querySelectorAll('input[name="discount-type"]').forEach(radio => {
                radio.addEventListener('change', updatePrice);
            });
            
            // 인터넷+TV 변경
            document.querySelectorAll('input[name="internet-tv"]').forEach(radio => {
                radio.addEventListener('change', updatePrice);
            });
            
            // 할부 개월 변경
            document.querySelectorAll('input[name="installment"]').forEach(radio => {
                radio.addEventListener('change', updatePrice);
            });
        }

        /**
         * ───────────────────────────────────────────────
         * 에러 표시
         * ───────────────────────────────────────────────
         */
        function showError(message) {
            const container = document.getElementById('detail-container');
            container.innerHTML = `<div class="error-message">${message}</div>`;
        }
    </script>
</body>
</html>