<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <base href="/tworld-store-frontend/">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì „ì²´ ê¸°ê¸° - SKT ê³µì‹ ì˜¨ë¼ì¸ìƒµ</title>
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <!-- í—¤ë” -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo">
                    <span class="logo-text">í‹°ì›”ë“œìŠ¤í† ì–´</span>
                </a>
                <nav class="main-nav">
                    <a href="devices.html?brand=samsung">ì‚¼ì„±</a>
                    <a href="devices.html?brand=apple">ì• í”Œ</a>
                    <a href="devices.html">ì „ì²´ê¸°ê¸°</a>
                    <a href="plans.html">ìš”ê¸ˆì œ</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="devices-page">
        <div class="container">
            <!-- í˜ì´ì§€ í—¤ë” -->
            <div class="page-header">
                <h1 class="page-title" id="page-title">ì „ì²´ ê¸°ê¸°</h1>
                <p class="page-count" id="page-count">ì´ 0ê°œ</p>
            </div>

            <!-- í•„í„° ë° ì •ë ¬ -->
            <div class="filter-bar">
                <!-- ë¸Œëœë“œ í•„í„° -->
                <div class="brand-filters">
                    <button class="filter-btn active" data-brand="all">ì „ì²´</button>
                    <button class="filter-btn" data-brand="samsung">ì‚¼ì„±</button>
                    <button class="filter-btn" data-brand="apple">ì• í”Œ</button>
                    <button class="filter-btn" data-brand="other">ê¸°íƒ€</button>
                </div>

                <!-- ì •ë ¬ -->
                <div class="sort-controls">
                    <select id="sort-select" class="sort-select">
                        <option value="order">ì¶”ì²œìˆœ</option>
                        <option value="price-low">ê°€ê²© ë‚®ì€ìˆœ</option>
                        <option value="price-high">ê°€ê²© ë†’ì€ìˆœ</option>
                        <option value="name">ì´ë¦„ìˆœ</option>
                    </select>
                </div>
            </div>

            <!-- ê¸°ê¸° ê·¸ë¦¬ë“œ -->
            <div class="devices-grid" id="devices-grid">
                <!-- JSë¡œ ë™ì  ìƒì„± -->
                <div class="loading-placeholder">
                    <p>ê¸°ê¸° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- í‘¸í„° -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-info">
                    <p>ê³ ê°ì„¼í„°: 1600-8939</p>
                    <p>ìƒë‹´ì‹œê°„: í‰ì¼ 09:00 - 18:00</p>
                </div>
                <div class="footer-legal">
                    <p>Â© 2025 SKT. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- JS íŒŒì¼ ë¡œë“œ -->
    <script src="js/cloudinary.js"></script>
    <script src="js/api.js"></script>
    <script src="js/calculator.js"></script>
    <script src="js/common.js"></script>
    
    <!-- ì¸ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        /**
         * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         * devices.html ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸
         * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         */

        // Cloudinary ì„¤ì •
        setCloudinaryConfig('tworld-store');

        // ì „ì—­ ë³€ìˆ˜
        let allDevices = [];  // ëª¨ë“  ê¸°ê¸° ë°ì´í„°
        let currentBrand = 'all';  // í˜„ì¬ ì„ íƒëœ ë¸Œëœë“œ
        let currentSort = 'order';  // í˜„ì¬ ì •ë ¬ ë°©ì‹

        /**
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         * í˜ì´ì§€ ì´ˆê¸°í™”
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         */
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('ğŸš€ devices.html ë¡œë“œ ì‹œì‘');
                
                // â˜… Calculator ì´ˆê¸°í™” (settings ë¡œë“œ)
                await calculator.init();
                console.log('âœ… Calculator ì´ˆê¸°í™” ì™„ë£Œ');
                
                // URL íŒŒë¼ë¯¸í„°ì—ì„œ ë¸Œëœë“œ í™•ì¸
                const urlParams = new URLSearchParams(window.location.search);
                const brandParam = urlParams.get('brand');
                if (brandParam) {
                    currentBrand = brandParam;
                }
                
                // í•„í„° ë²„íŠ¼ ì´ˆê¸° ìƒíƒœ ì„¤ì •
                updateFilterButtons();
                
                // ê¸°ê¸° ë°ì´í„° ë¡œë“œ
                await loadDevices();
                
                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                setupEventListeners();
                
                console.log('âœ… devices.html ë¡œë“œ ì™„ë£Œ');
                
            } catch (error) {
                console.error('âŒ í˜ì´ì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
                showError('í˜ì´ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        /**
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         * ê¸°ê¸° ë°ì´í„° ë¡œë“œ
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         */
        async function loadDevices() {
            try {
                // âœ… products.jsonë§Œ ë¡œë“œ (images.json ë¶ˆí•„ìš”)
                const allDevicesData = await api.getDevices();
                console.log(`âœ… ì „ì²´ ê¸°ê¸°ì˜µì…˜ ${allDevicesData.length}ê°œ ë¡œë“œ ì™„ë£Œ`);
                
                // ëª¨ë¸ë³„ë¡œ ê·¸ë£¹í™”
                const modelGroups = {};
                allDevicesData.forEach(device => {
                    const modelName = device.ëª¨ë¸ëª…;
                    if (!modelGroups[modelName]) {
                        modelGroups[modelName] = [];
                    }
                    modelGroups[modelName].push(device);
                });
                
                const modelNames = Object.keys(modelGroups);
                console.log(`âœ… ì´ ${modelNames.length}ê°œ ëª¨ë¸ ë°œê²¬`);
                
                // ê° ëª¨ë¸ë³„ ì¹´ë“œ ë°ì´í„° ìƒì„±
                allDevices = [];
                
                for (const modelName of modelNames) {
                    try {
                        // ì²« ë²ˆì§¸ ê¸°ê¸°ì˜µì…˜ì„ ëŒ€í‘œë¡œ ì‚¬ìš©
                        const device = modelGroups[modelName][0];
                        const deviceOptionId = device.ê¸°ê¸°ì˜µì…˜ID;
                        
                        // ë¸Œëœë“œ ê²°ì •
                        const brand = getBrandFromModel(device.ë¸Œëœë“œ);
                        
                        // ê¸°ë³¸ ìš”ê¸ˆì œ ë¡œë“œ (ì²« ë²ˆì§¸ 5G ìš”ê¸ˆì œ)
                        const allPlans = await api.getPlans();
                        const plan = allPlans.find(p => p.ì¹´í…Œê³ ë¦¬.includes('5G')) || allPlans[0];
                        
                        // ì§€ì›ê¸ˆ ë¡œë“œ (ê¸°ê¸°ë³€ê²½ ê¸°ì¤€)
                        const subsidy = await api.getSubsidy(deviceOptionId, plan.ìš”ê¸ˆì œID, 'ê¸°ê¸°ë³€ê²½');
                        
                        if (!plan || !subsidy) {
                            console.warn(`í•„ìˆ˜ ë°ì´í„° ì—†ìŒ: ${modelName}`);
                            continue;
                        }
                        
                        // ê°€ê²© ê³„ì‚°
                        const priceResult = calculator.calculate(
                            device,
                            plan,
                            subsidy,
                            {
                                discountType: 'subsidy',
                                installmentMonths: 24,
                                internetTv: 'none'
                            }
                        );
                        
                        // âœ… placeholder ì¸ë„¤ì¼
                        const thumbnailUrl = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="400" height="400"%3E%3Crect width="400" height="400" fill="%23f3f4f6"/%3E%3Ctext x="50%25" y="50%25" font-size="16" fill="%23666" text-anchor="middle" dy=".3em"%3EğŸ“± ' + encodeURIComponent(modelName) + '%3C/text%3E%3C/svg%3E';
                        
                        // ë°ì´í„° ì €ì¥
                        allDevices.push({
                            modelName: modelName,
                            brand: brand,
                            title: modelName, // âœ… ëª¨ë¸ëª… ê·¸ëŒ€ë¡œ ì‚¬ìš©
                            subtitle: `${device.ìš©ëŸ‰}GB Â· ${device.ìƒ‰ìƒëª…}`, // âœ… ê¸°ê¸° ì •ë³´ë¡œ subtitle ìƒì„±
                            thumbnailUrl: thumbnailUrl,
                            monthlyTotal: priceResult.monthlyTotal,
                            subsidyTotal: priceResult.subsidy.total,
                            releasePrice: priceResult.releasePrice,
                            badge: null, // âœ… ë°°ì§€ ì—†ìŒ
                            sortOrder: 999 // âœ… ê¸°ë³¸ ì •ë ¬ìˆœì„œ
                        });
                        
                    } catch (error) {
                        console.error(`ê¸°ê¸° ë°ì´í„° ìƒì„± ì‹¤íŒ¨: ${modelName}`, error);
                    }
                }
                
                console.log(`âœ… ì´ ${allDevices.length}ê°œ ê¸°ê¸° ë¡œë“œ ì™„ë£Œ`);
                
                // ë Œë”ë§
                renderDevices();
                
            } catch (error) {
                console.error('âŒ ê¸°ê¸° ë¡œë“œ ì‹¤íŒ¨:', error);
                throw error;
            }
        }
        

        /**
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         * ë¸Œëœë“œ ê²°ì • (ì‚¼ì„±/ì• í”Œ/ê¸°íƒ€)
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         */
        function getBrandFromModel(brandName) {
            const normalized = brandName.toLowerCase();
            
            if (normalized.includes('ì‚¼ì„±') || normalized.includes('samsung')) {
                return 'samsung';
            } else if (normalized.includes('ì• í”Œ') || normalized.includes('apple')) {
                return 'apple';
            } else {
                return 'other';  // LG, ìƒ¤ì˜¤ë¯¸, êµ¬ê¸€ ë“±
            }
        }

        /**
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         * ê¸°ê¸° ë Œë”ë§
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         */
        function renderDevices() {
            // 1. í•„í„°ë§
            let filteredDevices = allDevices;
            
            if (currentBrand !== 'all') {
                filteredDevices = allDevices.filter(d => d.brand === currentBrand);
            }
            
            // 2. ì •ë ¬
            filteredDevices = sortDevices(filteredDevices, currentSort);
            
            // 3. íƒ€ì´í‹€ ë° ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
            updatePageHeader(filteredDevices.length);
            
            // 4. ê·¸ë¦¬ë“œ ë Œë”ë§
            const grid = document.getElementById('devices-grid');
            grid.innerHTML = '';
            
            if (filteredDevices.length === 0) {
                grid.innerHTML = '<div class="no-results"><p>í•´ë‹¹ ì¡°ê±´ì˜ ê¸°ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';
                return;
            }
            
            filteredDevices.forEach(device => {
                const card = createDeviceCard(device);
                grid.appendChild(card);
            });
        }

        /**
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         * ê¸°ê¸° ì •ë ¬
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         */
        function sortDevices(devices, sortType) {
            const sorted = [...devices];
            
            switch (sortType) {
                case 'order':
                    // ì¶”ì²œìˆœ (sort_order ê¸°ì¤€)
                    sorted.sort((a, b) => a.sortOrder - b.sortOrder);
                    break;
                    
                case 'price-low':
                    // ê°€ê²© ë‚®ì€ìˆœ
                    sorted.sort((a, b) => a.monthlyTotal - b.monthlyTotal);
                    break;
                    
                case 'price-high':
                    // ê°€ê²© ë†’ì€ìˆœ
                    sorted.sort((a, b) => b.monthlyTotal - a.monthlyTotal);
                    break;
                    
                case 'name':
                    // ì´ë¦„ìˆœ
                    sorted.sort((a, b) => a.title.localeCompare(b.title, 'ko'));
                    break;
            }
            
            return sorted;
        }

        /**
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         * í˜ì´ì§€ í—¤ë” ì—…ë°ì´íŠ¸
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         */
        function updatePageHeader(count) {
            const titleMap = {
                'all': 'ì „ì²´ ê¸°ê¸°',
                'samsung': 'ì‚¼ì„±ì „ì',
                'apple': 'ì• í”Œ',
                'other': 'ê¸°íƒ€ ë¸Œëœë“œ'
            };
            
            document.getElementById('page-title').textContent = titleMap[currentBrand] || 'ì „ì²´ ê¸°ê¸°';
            document.getElementById('page-count').textContent = `ì´ ${count}ê°œ`;
        }

        /**
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         * í•„í„° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         */
        function updateFilterButtons() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                const brand = btn.dataset.brand;
                if (brand === currentBrand) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        /**
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         * ê¸°ê¸° ì¹´ë“œ ìƒì„±
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         */
        function createDeviceCard(device) {
            const card = document.createElement('div');
            card.className = 'device-card';
            card.onclick = () => {
                location.href = `device-detail.html?device=${encodeURIComponent(device.modelName)}`;
            };
            
            card.innerHTML = `
                <div class="device-card-image">
                    <img src="${device.thumbnailUrl}" alt="${device.title}" loading="lazy">
                    ${device.badge ? `<span class="badge">${device.badge}</span>` : ''}
                </div>
                <div class="device-card-body">
                    <h3 class="device-title">${device.title}</h3>
                    <p class="device-subtitle">${device.subtitle}</p>
                    <div class="device-prices">
                        <div class="price-row">
                            <span class="price-label">ì¶œê³ ê°€ í• ì¸ê¸ˆ</span>
                            <span class="price-value">${formatDiscount(device.subsidyTotal)}</span>
                        </div>
                        <div class="price-row total">
                            <span class="price-label">ì›” ì˜ˆìƒ ë‚©ë¶€</span>
                            <span class="price-value highlight">${formatMonthly(device.monthlyTotal)}</span>
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }

        /**
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         * ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         */
        function setupEventListeners() {
            // ë¸Œëœë“œ í•„í„° ë²„íŠ¼
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentBrand = btn.dataset.brand;
                    updateFilterButtons();
                    renderDevices();
                    
                    // URL ì—…ë°ì´íŠ¸ (íˆìŠ¤í† ë¦¬ ì¶”ê°€)
                    const newUrl = currentBrand === 'all' 
                        ? '/devices.html' 
                        : `/devices.html?brand=${currentBrand}`;
                    window.history.pushState({}, '', newUrl);
                });
            });
            
            // ì •ë ¬ ì…€ë ‰íŠ¸
            document.getElementById('sort-select').addEventListener('change', (e) => {
                currentSort = e.target.value;
                renderDevices();
            });
        }

        /**
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         * ì—ëŸ¬ í‘œì‹œ
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         */
        function showError(message) {
            const grid = document.getElementById('devices-grid');
            grid.innerHTML = `<div class="error-message">${message}</div>`;
        }
    </script>
</body>
</html>