<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>전체 기기 - SKT 공식 온라인샵</title>
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <!-- 헤더 -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo">
                    <span class="logo-text">티월드스토어</span>
                </a>
                <nav class="main-nav">
                    <a href="devices.html?brand=samsung">삼성</a>
                    <a href="devices.html?brand=apple">애플</a>
                    <a href="devices.html">전체기기</a>
                    <a href="plans.html">요금제</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- 메인 컨텐츠 -->
    <main class="devices-page">
        <div class="container">
            <!-- 페이지 헤더 -->
            <div class="page-header">
                <h1 class="page-title" id="page-title">전체 기기</h1>
                <p class="page-count" id="page-count">총 0개</p>
            </div>

            <!-- 필터 및 정렬 -->
            <div class="filter-bar">
                <!-- 브랜드 필터 -->
                <div class="brand-filters">
                    <button class="filter-btn active" data-brand="all">전체</button>
                    <button class="filter-btn" data-brand="samsung">삼성</button>
                    <button class="filter-btn" data-brand="apple">애플</button>
                    <button class="filter-btn" data-brand="other">기타</button>
                </div>

                <!-- 정렬 -->
                <div class="sort-controls">
                    <select id="sort-select" class="sort-select">
                        <option value="order">추천순</option>
                        <option value="price-low">가격 낮은순</option>
                        <option value="price-high">가격 높은순</option>
                        <option value="name">이름순</option>
                    </select>
                </div>
            </div>

            <!-- 기기 그리드 -->
            <div class="devices-grid" id="devices-grid">
                <!-- JS로 동적 생성 -->
                <div class="loading-placeholder">
                    <p>기기 정보를 불러오는 중...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- 푸터 -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-info">
                    <p>고객센터: 1600-8939</p>
                    <p>상담시간: 평일 09:00 - 18:00</p>
                </div>
                <div class="footer-legal">
                    <p>© 2025 SKT. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- JS 파일 로드 -->
    <script src="/js/cloudinary.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/calculator.js"></script>
    <script src="/js/common.js"></script>
    
    <!-- 인라인 스크립트 -->
    <script>
        /**
         * ═══════════════════════════════════════════════════
         * devices.html 메인 스크립트
         * ═══════════════════════════════════════════════════
         */

        // Cloudinary 설정
        setCloudinaryConfig('your-cloud-name');

        // 전역 변수
        let allDevices = [];  // 모든 기기 데이터
        let currentBrand = 'all';  // 현재 선택된 브랜드
        let currentSort = 'order';  // 현재 정렬 방식

        /**
         * ───────────────────────────────────────────────
         * 페이지 초기화
         * ───────────────────────────────────────────────
         */
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('🚀 devices.html 로드 시작');
                
                // URL 파라미터에서 브랜드 확인
                const urlParams = new URLSearchParams(window.location.search);
                const brandParam = urlParams.get('brand');
                if (brandParam) {
                    currentBrand = brandParam;
                }
                
                // 필터 버튼 초기 상태 설정
                updateFilterButtons();
                
                // 기기 데이터 로드
                await loadDevices();
                
                // 이벤트 리스너 등록
                setupEventListeners();
                
                console.log('✅ devices.html 로드 완료');
                
            } catch (error) {
                console.error('❌ 페이지 로드 실패:', error);
                showError('페이지를 불러오는 중 오류가 발생했습니다.');
            }
        });

        /**
         * ───────────────────────────────────────────────
         * 기기 데이터 로드
         * ───────────────────────────────────────────────
         */
        async function loadDevices() {
            try {
                // 1. images-devices.json 로드
                const imagesData = await api.loadImagesDevices();
                console.log('✅ images-devices.json 로드 완료');
                
                // 2. products.json 로드
                const productsData = await api.loadProducts();
                console.log('✅ products.json 로드 완료');
                
                // 3. 표시 가능한 모델 목록
                const visibleModels = Object.entries(imagesData.devices)
                    .filter(([_, data]) => data.visible)
                    .sort((a, b) => (a[1].sort_order || 999) - (b[1].sort_order || 999));
                
                // 4. 각 모델별 카드 데이터 생성
                allDevices = [];
                
                for (const [modelName, imageData] of visibleModels) {
                    try {
                        // 카드 데이터 가져오기
                        const cardData = await api.getCardData(modelName);
                        
                        if (!cardData) {
                            console.warn(`카드 데이터 없음: ${modelName}`);
                            continue;
                        }
                        
                        // 브랜드 결정
                        const brand = getBrandFromModel(cardData.device.브랜드);
                        
                        // 가격 계산
                        const priceResult = calculatePrice(
                            cardData.device,
                            cardData.plan,
                            cardData.subsidy,
                            {
                                discountType: 'subsidy',
                                installmentMonths: 24,
                                internetTv: 'none'
                            }
                        );
                        
                        // 썸네일 URL
                        const defaultColor = imageData.card.default.color;
                        const thumbnailPath = imageData.thumbnails[defaultColor].path;
                        const thumbnailUrl = getThumbnailUrl(thumbnailPath, 'medium');
                        
                        // 데이터 저장
                        allDevices.push({
                            modelName: modelName,
                            brand: brand,
                            title: imageData.card.title,
                            subtitle: imageData.card.subtitle,
                            thumbnailUrl: thumbnailUrl,
                            monthlyTotal: priceResult.monthlyTotal,
                            subsidyTotal: priceResult.subsidy.total,
                            releasePrice: priceResult.releasePrice,
                            badge: imageData.badge,
                            sortOrder: imageData.sort_order || 999
                        });
                        
                    } catch (error) {
                        console.error(`기기 데이터 생성 실패: ${modelName}`, error);
                    }
                }
                
                console.log(`✅ 총 ${allDevices.length}개 기기 로드 완료`);
                
                // 5. 렌더링
                renderDevices();
                
            } catch (error) {
                console.error('❌ 기기 로드 실패:', error);
                throw error;
            }
        }

        /**
         * ───────────────────────────────────────────────
         * 브랜드 결정 (삼성/애플/기타)
         * ───────────────────────────────────────────────
         */
        function getBrandFromModel(brandName) {
            const normalized = brandName.toLowerCase();
            
            if (normalized.includes('삼성') || normalized.includes('samsung')) {
                return 'samsung';
            } else if (normalized.includes('애플') || normalized.includes('apple')) {
                return 'apple';
            } else {
                return 'other';  // LG, 샤오미, 구글 등
            }
        }

        /**
         * ───────────────────────────────────────────────
         * 기기 렌더링
         * ───────────────────────────────────────────────
         */
        function renderDevices() {
            // 1. 필터링
            let filteredDevices = allDevices;
            
            if (currentBrand !== 'all') {
                filteredDevices = allDevices.filter(d => d.brand === currentBrand);
            }
            
            // 2. 정렬
            filteredDevices = sortDevices(filteredDevices, currentSort);
            
            // 3. 타이틀 및 카운트 업데이트
            updatePageHeader(filteredDevices.length);
            
            // 4. 그리드 렌더링
            const grid = document.getElementById('devices-grid');
            grid.innerHTML = '';
            
            if (filteredDevices.length === 0) {
                grid.innerHTML = '<div class="no-results"><p>해당 조건의 기기가 없습니다.</p></div>';
                return;
            }
            
            filteredDevices.forEach(device => {
                const card = createDeviceCard(device);
                grid.appendChild(card);
            });
        }

        /**
         * ───────────────────────────────────────────────
         * 기기 정렬
         * ───────────────────────────────────────────────
         */
        function sortDevices(devices, sortType) {
            const sorted = [...devices];
            
            switch (sortType) {
                case 'order':
                    // 추천순 (sort_order 기준)
                    sorted.sort((a, b) => a.sortOrder - b.sortOrder);
                    break;
                    
                case 'price-low':
                    // 가격 낮은순
                    sorted.sort((a, b) => a.monthlyTotal - b.monthlyTotal);
                    break;
                    
                case 'price-high':
                    // 가격 높은순
                    sorted.sort((a, b) => b.monthlyTotal - a.monthlyTotal);
                    break;
                    
                case 'name':
                    // 이름순
                    sorted.sort((a, b) => a.title.localeCompare(b.title, 'ko'));
                    break;
            }
            
            return sorted;
        }

        /**
         * ───────────────────────────────────────────────
         * 페이지 헤더 업데이트
         * ───────────────────────────────────────────────
         */
        function updatePageHeader(count) {
            const titleMap = {
                'all': '전체 기기',
                'samsung': '삼성전자',
                'apple': '애플',
                'other': '기타 브랜드'
            };
            
            document.getElementById('page-title').textContent = titleMap[currentBrand] || '전체 기기';
            document.getElementById('page-count').textContent = `총 ${count}개`;
        }

        /**
         * ───────────────────────────────────────────────
         * 필터 버튼 상태 업데이트
         * ───────────────────────────────────────────────
         */
        function updateFilterButtons() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                const brand = btn.dataset.brand;
                if (brand === currentBrand) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        /**
         * ───────────────────────────────────────────────
         * 기기 카드 생성
         * ───────────────────────────────────────────────
         */
        function createDeviceCard(device) {
            const card = document.createElement('div');
            card.className = 'device-card';
            card.onclick = () => {
                location.href = `/device-detail.html?model=${encodeURIComponent(device.modelName)}`;
            };
            
            card.innerHTML = `
                <div class="device-card-image">
                    <img src="${device.thumbnailUrl}" alt="${device.title}" loading="lazy">
                    ${device.badge ? `<span class="badge">${device.badge}</span>` : ''}
                </div>
                <div class="device-card-body">
                    <h3 class="device-title">${device.title}</h3>
                    <p class="device-subtitle">${device.subtitle}</p>
                    <div class="device-prices">
                        <div class="price-row">
                            <span class="price-label">출고가 할인금</span>
                            <span class="price-value">${formatDiscount(device.subsidyTotal)}</span>
                        </div>
                        <div class="price-row total">
                            <span class="price-label">월 예상 납부</span>
                            <span class="price-value highlight">${formatMonthly(device.monthlyTotal)}</span>
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }

        /**
         * ───────────────────────────────────────────────
         * 이벤트 리스너 설정
         * ───────────────────────────────────────────────
         */
        function setupEventListeners() {
            // 브랜드 필터 버튼
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentBrand = btn.dataset.brand;
                    updateFilterButtons();
                    renderDevices();
                    
                    // URL 업데이트 (히스토리 추가)
                    const newUrl = currentBrand === 'all' 
                        ? '/devices.html' 
                        : `/devices.html?brand=${currentBrand}`;
                    window.history.pushState({}, '', newUrl);
                });
            });
            
            // 정렬 셀렉트
            document.getElementById('sort-select').addEventListener('change', (e) => {
                currentSort = e.target.value;
                renderDevices();
            });
        }

        /**
         * ───────────────────────────────────────────────
         * 에러 표시
         * ───────────────────────────────────────────────
         */
        function showError(message) {
            const grid = document.getElementById('devices-grid');
            grid.innerHTML = `<div class="error-message">${message}</div>`;
        }
    </script>
</body>
</html>