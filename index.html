<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <base href="/tworld-store-frontend/">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKT 공식 온라인샵 - 최신 스마트폰</title>
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <!-- 헤더 -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo">
                    <span class="logo-text">티월드스토어</span>
                </a>
                <nav class="main-nav">
                    <a href="devices.html?brand=samsung">삼성</a>
                    <a href="devices.html?brand=apple">애플</a>
                    <a href="devices.html">전체기기</a>
                    <a href="plans.html">요금제</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- 히어로 슬라이더 -->
    <section class="hero-section">
        <div class="hero-slider" id="hero-slider">
            <!-- JS로 동적 생성 -->
            <div class="slider-loading">
                <p>로딩 중...</p>
            </div>
        </div>
        <div class="slider-dots" id="slider-dots">
            <!-- JS로 동적 생성 -->
        </div>
    </section>

    <!-- 인기 기기 섹션 -->
    <section class="popular-section">
        <div class="container">
            <h2 class="section-title" id="popular-title">최신 스마트폰</h2>
            <div class="devices-grid" id="popular-devices">
                <!-- JS로 동적 생성 -->
                <div class="loading-placeholder">
                    <p>기기 정보를 불러오는 중...</p>
                </div>
            </div>
        </div>
    </section>

    <!-- 중간 배너 -->
    <section class="middle-banner-section" id="middle-banner-section">
        <!-- JS로 동적 생성 -->
    </section>

    <!-- 하단 프로모션 -->
    <section class="promo-section">
        <div class="container">
            <div class="promo-grid" id="promo-grid">
                <!-- JS로 동적 생성 -->
            </div>
        </div>
    </section>

    <!-- 푸터 -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-info">
                    <p>고객센터: 1600-8939</p>
                    <p>상담시간: 평일 09:00 - 18:00</p>
                </div>
                <div class="footer-legal">
                    <p>© 2025 SKT. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- JS 파일 로드 -->
    <script src="js/cloudinary.js"></script>
    <script src="js/api.js"></script>
    <script src="js/calculator.js"></script>
    <script src="js/common.js"></script>
    
    <!-- 인라인 스크립트 -->
    <script>
        /**
         * ═══════════════════════════════════════════════════
         * index.html 메인 스크립트
         * ═══════════════════════════════════════════════════
         */

        // Cloudinary 설정 (실제 사용시 변경 필요)
        setCloudinaryConfig('tworld-store');

        /**
         * ───────────────────────────────────────────────
         * 페이지 초기화
         * ───────────────────────────────────────────────
         */
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('🚀 index.html 로드 시작');
                
                // 1. images-index.json 로드
                const imagesData = await api.loadImagesIndex();
                console.log('✅ images-index.json 로드 완료');
                
                // 2. 각 섹션 렌더링
                await Promise.all([
                    renderHeroSlider(imagesData.hero_slider),
                    renderPopularDevices(imagesData.popular_devices),
                    renderMiddleBanner(imagesData.middle_banner),
                    renderPromoBlocks(imagesData.bottom_promos)
                ]);
                
                console.log('✅ 모든 섹션 렌더링 완료');
                
            } catch (error) {
                console.error('❌ 페이지 로드 실패:', error);
                showError('페이지를 불러오는 중 오류가 발생했습니다.');
            }
        });

        /**
         * ───────────────────────────────────────────────
         * 히어로 슬라이더 렌더링
         * ───────────────────────────────────────────────
         */
        async function renderHeroSlider(sliderConfig) {
            if (!sliderConfig || !sliderConfig.enabled) {
                document.querySelector('.hero-section').style.display = 'none';
                return;
            }
            
            const slider = document.getElementById('hero-slider');
            const dots = document.getElementById('slider-dots');
            
            // 슬라이드 생성
            slider.innerHTML = '';
            dots.innerHTML = '';
            
            sliderConfig.slides.forEach((slide, index) => {
                // 슬라이드 아이템
                const slideItem = document.createElement('div');
                slideItem.className = 'slider-item' + (index === 0 ? ' active' : '');
                
                const link = document.createElement('a');
                link.href = slide.link || '#';
                
                const img = document.createElement('img');
                img.src = getBannerUrl(slide.path, 'hero');
                img.alt = slide.alt;
                img.loading = index === 0 ? 'eager' : 'lazy';
                
                link.appendChild(img);
                slideItem.appendChild(link);
                slider.appendChild(slideItem);
                
                // 도트 인디케이터
                const dot = document.createElement('button');
                dot.className = 'slider-dot' + (index === 0 ? ' active' : '');
                dot.setAttribute('aria-label', `슬라이드 ${index + 1}`);
                dot.onclick = () => goToSlide(index);
                dots.appendChild(dot);
            });
            
            // 자동 재생
            if (sliderConfig.auto_play) {
                startAutoPlay(sliderConfig.interval || 5000);
            }
        }

        /**
         * ───────────────────────────────────────────────
         * 슬라이더 자동 재생
         * ───────────────────────────────────────────────
         */
        let autoPlayInterval;
        let currentSlide = 0;
        
        function startAutoPlay(interval) {
            autoPlayInterval = setInterval(() => {
                const slides = document.querySelectorAll('.slider-item');
                currentSlide = (currentSlide + 1) % slides.length;
                goToSlide(currentSlide);
            }, interval);
        }
        
        function goToSlide(index) {
            const slides = document.querySelectorAll('.slider-item');
            const dots = document.querySelectorAll('.slider-dot');
            
            slides.forEach(slide => slide.classList.remove('active'));
            dots.forEach(dot => dot.classList.remove('active'));
            
            slides[index].classList.add('active');
            dots[index].classList.add('active');
            
            currentSlide = index;
        }

        /**
         * ───────────────────────────────────────────────
         * 인기 기기 렌더링
         * ───────────────────────────────────────────────
         */
        async function renderPopularDevices(popularConfig) {
            if (!popularConfig || !popularConfig.enabled) {
                document.querySelector('.popular-section').style.display = 'none';
                return;
            }
            
            // 제목 설정
            document.getElementById('popular-title').textContent = 
                popularConfig.title || '최신 스마트폰';
            
            const container = document.getElementById('popular-devices');
            container.innerHTML = '';
            
            // 표시할 모델 수 제한
            const modelsToShow = popularConfig.models.slice(0, popularConfig.layout || 8);
            
            // 각 모델별 카드 생성
            for (const modelName of modelsToShow) {
                try {
                    // 완전한 카드 데이터 가져오기 (images + products)
                    const cardData = await api.getCardData(modelName);
                    
                    if (!cardData) {
                        console.warn(`카드 데이터 없음: ${modelName}`);
                        continue;
                    }
                    
                    // 가격 계산
                    const priceResult = calculatePrice(
                        cardData.device,
                        cardData.plan,
                        cardData.subsidy,
                        {
                            discountType: cardData.image.card.default.join_type === '기기변경' ? 'subsidy' : 'subsidy',
                            installmentMonths: 24,
                            internetTv: 'none'
                        }
                    );
                    
                    // 썸네일 URL
                    const defaultColor = cardData.image.card.default.color;
                    const thumbnailPath = cardData.image.thumbnails[defaultColor].path;
                    const thumbnailUrl = getThumbnailUrl(thumbnailPath, 'medium');
                    
                    // 뱃지
                    const badge = popularConfig.badges && popularConfig.badges[modelName];
                    
                    // 카드 생성
                    const card = createDeviceCard({
                        modelName: modelName,
                        title: cardData.image.card.title,
                        subtitle: cardData.image.card.subtitle,
                        thumbnailUrl: thumbnailUrl,
                        monthlyTotal: priceResult.monthlyTotal,
                        subsidyTotal: priceResult.subsidy.total,
                        badge: badge
                    });
                    
                    container.appendChild(card);
                    
                } catch (error) {
                    console.error(`카드 생성 실패: ${modelName}`, error);
                }
            }
        }

        /**
         * ───────────────────────────────────────────────
         * 기기 카드 생성
         * ───────────────────────────────────────────────
         */
        function createDeviceCard(data) {
            const card = document.createElement('div');
            card.className = 'device-card';
            card.onclick = () => {
                location.href = `device-detail.html?device=${encodeURIComponent(data.modelName)}`;
            };
            
            card.innerHTML = `
                <div class="device-card-image">
                    <img src="${data.thumbnailUrl}" alt="${data.title}" loading="lazy">
                    ${data.badge ? `<span class="badge" style="background-color: ${data.badge.color}">${data.badge.text}</span>` : ''}
                </div>
                <div class="device-card-body">
                    <h3 class="device-title">${data.title}</h3>
                    <p class="device-subtitle">${data.subtitle}</p>
                    <div class="device-prices">
                        <div class="price-row">
                            <span class="price-label">출고가 할인금</span>
                            <span class="price-value">${formatDiscount(data.subsidyTotal)}</span>
                        </div>
                        <div class="price-row total">
                            <span class="price-label">월 예상 납부</span>
                            <span class="price-value highlight">${formatMonthly(data.monthlyTotal)}</span>
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }

        /**
         * ───────────────────────────────────────────────
         * 중간 배너 렌더링
         * ───────────────────────────────────────────────
         */
        function renderMiddleBanner(bannerConfig) {
            const section = document.getElementById('middle-banner-section');
            
            if (!bannerConfig || !bannerConfig.enabled) {
                section.style.display = 'none';
                return;
            }
            
            const bannerUrl = getBannerUrl(bannerConfig.path, 'middle');
            
            section.innerHTML = `
                <div class="container">
                    <a href="${bannerConfig.link || '#'}" class="middle-banner-link">
                        <img src="${bannerUrl}" alt="${bannerConfig.alt}" loading="lazy">
                    </a>
                </div>
            `;
        }

        /**
         * ───────────────────────────────────────────────
         * 하단 프로모션 블록 렌더링
         * ───────────────────────────────────────────────
         */
        function renderPromoBlocks(promosConfig) {
            if (!promosConfig || !promosConfig.enabled) {
                document.querySelector('.promo-section').style.display = 'none';
                return;
            }
            
            const container = document.getElementById('promo-grid');
            container.innerHTML = '';
            
            // 레이아웃에 따라 클래스 설정
            container.className = `promo-grid layout-${promosConfig.layout}`;
            
            // 각 프로모션 블록
            promosConfig.items.forEach(item => {
                const promoUrl = getBannerUrl(item.path, 'promo');
                
                const promoItem = document.createElement('div');
                promoItem.className = 'promo-item';
                
                promoItem.innerHTML = `
                    <a href="${item.link || '#'}">
                        <img src="${promoUrl}" alt="${item.alt}" loading="lazy">
                    </a>
                `;
                
                container.appendChild(promoItem);
            });
        }

        /**
         * ───────────────────────────────────────────────
         * 에러 표시
         * ───────────────────────────────────────────────
         */
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.body.insertBefore(errorDiv, document.body.firstChild);
        }
    </script>
</body>
</html>